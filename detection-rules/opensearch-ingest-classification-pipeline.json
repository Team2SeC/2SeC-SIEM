{
  "description": "2SeC SIEM Level 1 classification in OpenSearch ingest pipeline (v1.0)",
  "processors": [
    {
      "script": {
        "lang": "painless",
        "source": "void addTag(def tags, String t) { if (tags != null && !tags.contains(t)) { tags.add(t); } }\nvoid setAttack(def ctx, def tags, String ruleId, String type, String category, String severity, String tag) {\n  ctx.attack = new HashMap();\n  ctx.attack.rule_id = ruleId;\n  ctx.attack.type = type;\n  ctx.attack.category = category;\n  ctx.attack.severity = severity;\n  if (ctx.detection == null) { ctx.detection = new HashMap(); }\n  ctx.detection.stage = \"classification\";\n  ctx.detection.source = \"opensearch\";\n  ctx.detection.version = \"v1.0\";\n  addTag(tags, \"attack\");\n  addTag(tags, tag);\n}\n\nif (ctx.tags == null) { ctx.tags = new ArrayList(); }\ndef tags = ctx.tags;\n\ndef url = ctx.containsKey('url') ? ctx.url : null;\ndef path = (url != null && url.containsKey('path')) ? url.path : null;\ndef query = (url != null && url.containsKey('query')) ? url.query : null;\n\ndef ua = ctx.containsKey('user_agent') ? ctx.user_agent : null;\ndef uaOrig = (ua != null && ua.containsKey('original')) ? ua.original : null;\n\ndef http = ctx.containsKey('http') ? ctx.http : null;\ndef request = (http != null && http.containsKey('request')) ? http.request : null;\ndef response = (http != null && http.containsKey('response')) ? http.response : null;\ndef method = (request != null && request.containsKey('method')) ? request.method : null;\nif (method instanceof List && method.size() > 0) {\n  method = method[0];\n}\ndef status = (response != null && response.containsKey('status_code')) ? response.status_code : null;\ndef statusStr = status == null ? null : status.toString();\n\nboolean isGet = method != null && method.equalsIgnoreCase(\"GET\");\nboolean isPost = method != null && method.equalsIgnoreCase(\"POST\");\nboolean isHead = method != null && method.equalsIgnoreCase(\"HEAD\");\n\ndef queryLower = query != null ? query.toLowerCase() : null;\ndef pathLower = path != null ? path.toLowerCase() : null;\ndef uaLower = uaOrig != null ? uaOrig.toLowerCase() : null;\n\n// WEB-SQLI-001\nif ((isGet || isPost) && (\"200\".equals(statusStr) || \"500\".equals(statusStr))) {\n  if (queryLower != null && (\n    queryLower.contains(\"union select\") ||\n    queryLower.contains(\"union all select\") ||\n    queryLower.contains(\"/*!union*/ select\") ||\n    queryLower.contains(\"union/**/select\") ||\n    queryLower.contains(\"' or 1=1\") ||\n    queryLower.contains(\"' or '1'='1\") ||\n    queryLower.contains(\"\\\" or \\\"1\\\"=\\\"1\") ||\n    queryLower.contains(\"') or ('1'='1\") ||\n    queryLower.contains(\"sleep(\") ||\n    queryLower.contains(\"waitfor delay\") ||\n    queryLower.contains(\"benchmark(\") ||\n    queryLower.contains(\"database()\") ||\n    queryLower.contains(\"user()\") ||\n    queryLower.contains(\"@@version\") ||\n    queryLower.contains(\"information_schema.tables\") ||\n    queryLower.contains(\"information_schema.columns\") ||\n    queryLower.contains(\"information_schema\") ||\n    queryLower.contains(\"extractvalue(\") ||\n    queryLower.contains(\"updatexml(\") ||\n    queryLower.contains(\"concat(\") ||\n    queryLower.contains(\"group_concat(\") ||\n    queryLower.contains(\"; drop table\") ||\n    queryLower.contains(\"; delete from\") ||\n    queryLower.contains(\"admin' --\") ||\n    queryLower.contains(\"'; --\") ||\n    queryLower.contains(\"--\") ||\n    queryLower.contains(\"#\") ||\n    queryLower.contains(\"%27%20or%201%3d1\") ||\n    queryLower.contains(\"%55%4e%49%4f%4e\") ||\n    queryLower.contains(\"char(85,78,73,79,78\") ||\n    queryLower.contains(\"union%20select\") ||\n    queryLower.contains(\"union+select\")\n  )) {\n    setAttack(ctx, tags, \"WEB-SQLI-001\", \"SQL Injection\", \"Injection\", \"medium\", \"sqli\");\n  }\n}\n\n// WEB-XSS-001\nif (queryLower != null && (isGet || isPost) && (\"200\".equals(statusStr) || \"302\".equals(statusStr) || \"500\".equals(statusStr))) {\n  if (queryLower.contains(\"<script\") || queryLower.contains(\"</script\") ||\n      queryLower.contains(\"<script src=\") || queryLower.contains(\"<img\") ||\n      queryLower.contains(\"<iframe\") || queryLower.contains(\"<svg\") ||\n      queryLower.contains(\"<object\") || queryLower.contains(\"<embed\") ||\n      queryLower.contains(\"<video\") || queryLower.contains(\"<audio\") ||\n      queryLower.contains(\"onerror=\") || queryLower.contains(\"onload=\") ||\n      queryLower.contains(\"onclick=\") || queryLower.contains(\"onmouseover=\") ||\n      queryLower.contains(\"onfocus=\") || queryLower.contains(\"onblur=\") ||\n      queryLower.contains(\"javascript:\") || queryLower.contains(\"vbscript:\") ||\n      queryLower.contains(\"data:text/html\") || queryLower.contains(\"alert\") ||\n      queryLower.contains(\"prompt\") || queryLower.contains(\"confirm\") ||\n      queryLower.contains(\"eval\") || queryLower.contains(\"%3cscript%3e\") ||\n      queryLower.contains(\"%3cimg\") || queryLower.contains(\"&lt;script&gt;\") ||\n      queryLower.contains(\"&#60;script&#62;\") || queryLower.contains(\"\\\\x3cscript\\\\x3e\")) {\n    setAttack(ctx, tags, \"WEB-XSS-001\", \"Cross-Site Scripting\", \"Client-Side\", \"medium\", \"xss\");\n  }\n}\n\n// WEB-PATH-001\nif ((isGet || isPost) && (\"200\".equals(statusStr) || \"403\".equals(statusStr) || \"404\".equals(statusStr) || \"500\".equals(statusStr))) {\n  boolean pathMatch = pathLower != null && (\n    pathLower.contains(\"../\") || pathLower.contains(\"..\\\\\") ||\n    pathLower.contains(\"%2e%2e%2f\") || pathLower.contains(\"%2e%2e%5c\") ||\n    pathLower.contains(\"..%2f\") || pathLower.contains(\"..%5c\") ||\n    pathLower.contains(\"..%252f\")\n  );\n  boolean queryMatch = queryLower != null && (\n    queryLower.contains(\"../\") || queryLower.contains(\"..\\\\\") ||\n    queryLower.contains(\"%2e%2e%2f\") || queryLower.contains(\"%2e%2e%5c\") ||\n    queryLower.contains(\"..%2f\") || queryLower.contains(\"..%5c\") ||\n    queryLower.contains(\"..%252f\") ||\n    queryLower.contains(\"/etc/passwd\") || queryLower.contains(\"/etc/shadow\") ||\n    queryLower.contains(\"/etc/hosts\") || queryLower.contains(\"boot.ini\") ||\n    queryLower.contains(\"win.ini\") || queryLower.contains(\"windows\\\\system32\\\\drivers\\\\etc\\\\hosts\") ||\n    queryLower.contains(\"file=\") || queryLower.contains(\"page=\") ||\n    queryLower.contains(\"path=\") || queryLower.contains(\"include=\") ||\n    queryLower.contains(\"dir=\")\n  );\n  if (pathMatch || queryMatch) {\n    setAttack(ctx, tags, \"WEB-PATH-001\", \"Path Traversal\", \"File Access\", \"medium\", \"path_traversal\");\n  }\n}\n\n// WEB-CMD-001\nif (queryLower != null && (isGet || isPost) && (\"200\".equals(statusStr) || \"500\".equals(statusStr))) {\n  if (queryLower.contains(\";\") || queryLower.contains(\"|\") ||\n      queryLower.contains(\"&&\") || queryLower.contains(\"||\") ||\n      queryLower.contains(\"`\") || queryLower.contains(\"$(\") ||\n      queryLower.contains(\"%3b\") || queryLower.contains(\"%7c\") ||\n      queryLower.contains(\"%26%26\") || queryLower.contains(\"%7c%7c\") ||\n      queryLower.contains(\"%24%28\") ||\n      queryLower.contains(\"whoami\") || queryLower.contains(\"id\") ||\n      queryLower.contains(\"ls\") || queryLower.contains(\"cat\") ||\n      queryLower.contains(\"pwd\") || queryLower.contains(\"uname\") ||\n      queryLower.contains(\"hostname\") || queryLower.contains(\"ifconfig\") ||\n      queryLower.contains(\"wget\") || queryLower.contains(\"curl\") ||\n      queryLower.contains(\"nc\") || queryLower.contains(\"bash\") ||\n      queryLower.contains(\"sh\") || queryLower.contains(\"python\") ||\n      queryLower.contains(\"/etc/passwd\") || queryLower.contains(\"/etc/shadow\")) {\n    setAttack(ctx, tags, \"WEB-CMD-001\", \"Command Injection\", \"Injection\", \"high\", \"cmdi\");\n  }\n}\n\n// WEB-SCAN-001\nif ((isGet || isHead) && (\"404\".equals(statusStr) || \"403\".equals(statusStr))) {\n  boolean pathScan = pathLower != null && (\n    pathLower.contains(\"/phpmyadmin\") || pathLower.contains(\"/wp-admin\") ||\n    pathLower.contains(\"/admin\") || pathLower.contains(\"/administrator\") ||\n    pathLower.contains(\"/manager\") || pathLower.contains(\"/control-panel\") ||\n    pathLower.contains(\"/cpanel\") || pathLower.contains(\"/backup\") ||\n    pathLower.contains(\"/backup.zip\") || pathLower.contains(\"/backup.tar.gz\") ||\n    pathLower.contains(\"/db_backup.sql\") || pathLower.contains(\"/website.bak\") ||\n    pathLower.contains(\"/old\") || pathLower.contains(\"/test\") ||\n    pathLower.contains(\"/dev\") || pathLower.contains(\"/debug\") ||\n    pathLower.contains(\"/phpinfo.php\") || pathLower.contains(\"/info.php\") ||\n    pathLower.contains(\"/test.php\") || pathLower.contains(\"/api\") ||\n    pathLower.contains(\"/api/v1\") || pathLower.contains(\"/api/swagger\") ||\n    pathLower.contains(\"/api-docs\") || pathLower.contains(\"/swagger-ui\") ||\n    pathLower.contains(\"/graphql\") || pathLower.contains(\"/graphql-playground\") ||\n    pathLower.contains(\"/.git\") || pathLower.contains(\"/.git/config\") ||\n    pathLower.contains(\"/.env\") || pathLower.contains(\"/.env.production\") ||\n    pathLower.contains(\"/config.php\") || pathLower.contains(\"/configuration.php\") ||\n    pathLower.contains(\"/wp-config.php\") || pathLower.contains(\"/settings.py\") ||\n    pathLower.contains(\"/server-status\") || pathLower.contains(\"/server-info\") ||\n    pathLower.contains(\"/status\") || pathLower.contains(\"/health\") ||\n    pathLower.contains(\"/metrics\") || pathLower.contains(\"/robots.txt\") ||\n    pathLower.contains(\"/sitemap.xml\") || pathLower.contains(\"/icons\") ||\n    pathLower.contains(\"/wp-content\") || pathLower.contains(\"/wp-includes\") ||\n    pathLower.contains(\"/admin/config\") || pathLower.contains(\"/storage\") ||\n    pathLower.contains(\"/mysql\") || pathLower.contains(\"/database\")\n  );\n  boolean uaScan = uaLower != null && (\n    uaLower.contains(\"sqlmap\") || uaLower.contains(\"nikto\") ||\n    uaLower.contains(\"nmap\") || uaLower.contains(\"dirb\") ||\n    uaLower.contains(\"dirbuster\") || uaLower.contains(\"gobuster\") ||\n    uaLower.contains(\"wfuzz\") || uaLower.contains(\"burp\") ||\n    uaLower.contains(\"zap\") || uaLower.contains(\"w3af\") ||\n    uaLower.contains(\"curl\") || uaLower.contains(\"wget\") ||\n    uaLower.contains(\"python\") || uaLower.contains(\"scanner\") ||\n    uaLower.contains(\"bot\") || uaLower.contains(\"crawl\") ||\n    uaLower.contains(\"nuclei\") || uaLower.contains(\"ffuf\") ||\n    uaLower.contains(\"dirsearch\")\n  );\n  if (pathScan || uaScan) {\n    setAttack(ctx, tags, \"WEB-SCAN-001\", \"Web Scanning\", \"Reconnaissance\", \"low\", \"scan\");\n  }\n}\n\n// WEB-404-001\nif ((isGet || isHead) && \"404\".equals(statusStr)) {\n  setAttack(ctx, tags, \"WEB-404-001\", \"Repeated 404 Access\", \"Reconnaissance\", \"low\", \"repeated_404\");\n}\n\n// WEB-UA-001\nif ((isGet || isPost || isHead) && uaLower != null) {\n  if (uaLower.contains(\"sqlmap\") || uaLower.contains(\"nikto\") ||\n      uaLower.contains(\"nmap\") || uaLower.contains(\"masscan\") ||\n      uaLower.contains(\"dirb\") || uaLower.contains(\"dirbuster\") ||\n      uaLower.contains(\"gobuster\") || uaLower.contains(\"wfuzz\") ||\n      uaLower.contains(\"dirsearch\") || uaLower.contains(\"ffuf\") ||\n      uaLower.contains(\"burp\") || uaLower.contains(\"zap\") ||\n      uaLower.contains(\"w3af\") || uaLower.contains(\"nuclei\") ||\n      uaLower.contains(\"acunetix\") || uaLower.contains(\"nessus\") ||\n      uaLower.contains(\"openvas\") || uaLower.contains(\"curl\") ||\n      uaLower.contains(\"wget\") || uaLower.contains(\"python-requests\") ||\n      uaLower.contains(\"go-http-client\") || uaLower.contains(\"apache-httpclient\") ||\n      uaLower.contains(\"java/\") || uaLower.contains(\"libwww\") ||\n      uaLower.contains(\"scrapy\") || uaLower.contains(\"python-urllib\") ||\n      uaLower.contains(\"windowspowershell\") ||\n      uaLower.contains(\"bot\") || uaLower.contains(\"spider\") ||\n      uaLower.contains(\"crawler\") || uaLower.contains(\"scraper\") ||\n      uaLower.contains(\"scanner\")) {\n    setAttack(ctx, tags, \"WEB-UA-001\", \"Suspicious User-Agent\", \"Reconnaissance\", \"low\", \"suspicious_ua\");\n  }\n}\n\n// WEB-AUTH-001\nif ((isPost || isGet) && pathLower != null && (\"401\".equals(statusStr) || \"403\".equals(statusStr) || \"200\".equals(statusStr) || \"302\".equals(statusStr))) {\n  if (pathLower.contains(\"/login\") || pathLower.contains(\"/login.php\") ||\n      pathLower.contains(\"/login.html\") || pathLower.contains(\"/signin\") ||\n      pathLower.contains(\"/sign-in\") || pathLower.contains(\"/sign_in\") ||\n      pathLower.contains(\"/logon\") || pathLower.contains(\"/logon.php\") ||\n      pathLower.contains(\"/authenticate\") || pathLower.contains(\"/authentication\") ||\n      pathLower.contains(\"/auth\") || pathLower.contains(\"/admin/login\") ||\n      pathLower.contains(\"/admin/login.php\") || pathLower.contains(\"/administrator/login\") ||\n      pathLower.contains(\"/wp-login.php\") || pathLower.contains(\"/manager/login\") ||\n      pathLower.contains(\"/control-panel/login\") || pathLower.contains(\"/api/auth\") ||\n      pathLower.contains(\"/api/login\") || pathLower.contains(\"/api/v1/authenticate\") ||\n      pathLower.contains(\"/api/v1/token\") || pathLower.contains(\"/oauth/token\") ||\n      pathLower.contains(\"/administrator/index.php\") ||\n      pathLower.contains(\"/user/login\") || pathLower.contains(\"/admin\") ||\n      pathLower.contains(\"/customer/account/login\")) {\n    setAttack(ctx, tags, \"WEB-AUTH-001\", \"Login Bruteforce\", \"Authentication Abuse\", \"high\", \"auth_bruteforce\");\n  }\n}\n\n// WEB-TIMEOUT-001\nif ((isGet || isPost || isHead) && \"408\".equals(statusStr)) {\n  setAttack(ctx, tags, \"WEB-TIMEOUT-001\", \"Slow Request\", \"Availability\", \"medium\", \"timeout\");\n}\n"
      }
    }
  ]
}