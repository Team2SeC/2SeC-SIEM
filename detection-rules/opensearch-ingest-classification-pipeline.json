{
  "description": "2SeC SIEM Level 1 classification in OpenSearch ingest pipeline (v1.0)",
  "processors": [
    {
      "script": {
        "lang": "painless",
        "source": "void addTag(def tags, String t) { if (tags != null && !tags.contains(t)) { tags.add(t); } }\nvoid setAttack(def ctx, def tags, String ruleId, String type, String category, String severity, String tag) {\n  ctx.attack = new HashMap();\n  ctx.attack.rule_id = ruleId;\n  ctx.attack.type = type;\n  ctx.attack.category = category;\n  ctx.attack.severity = severity;\n  if (ctx.detection == null) { ctx.detection = new HashMap(); }\n  ctx.detection.stage = \"classification\";\n  ctx.detection.source = \"opensearch\";\n  ctx.detection.version = \"v1.0\";\n  addTag(tags, \"attack\");\n  addTag(tags, tag);\n}\n\nif (ctx.tags == null) { ctx.tags = new ArrayList(); }\ndef tags = ctx.tags;\n\ndef url = ctx.containsKey('url') ? ctx.url : null;\ndef path = (url != null && url.containsKey('path')) ? url.path : null;\ndef query = (url != null && url.containsKey('query')) ? url.query : null;\n\ndef ua = ctx.containsKey('user_agent') ? ctx.user_agent : null;\ndef uaOrig = (ua != null && ua.containsKey('original')) ? ua.original : null;\n\ndef http = ctx.containsKey('http') ? ctx.http : null;\ndef request = (http != null && http.containsKey('request')) ? http.request : null;\ndef response = (http != null && http.containsKey('response')) ? http.response : null;\ndef method = (request != null && request.containsKey('method')) ? request.method : null;\ndef status = (response != null && response.containsKey('status_code')) ? response.status_code : null;\ndef statusStr = status == null ? null : status.toString();\n\nboolean isGet = method != null && method.equalsIgnoreCase(\"GET\");\nboolean isPost = method != null && method.equalsIgnoreCase(\"POST\");\nboolean isHead = method != null && method.equalsIgnoreCase(\"HEAD\");\n\ndef queryLower = query != null ? query.toLowerCase() : null;\ndef pathLower = path != null ? path.toLowerCase() : null;\ndef uaLower = uaOrig != null ? uaOrig.toLowerCase() : null;\n\n// WEB-SQLI-001\nif ((isGet || isPost) && (\"200\".equals(statusStr) || \"500\".equals(statusStr))) {\n  if (queryLower != null && (\n    queryLower.contains(\"union select\") ||\n    queryLower.contains(\"' or 1=1\") ||\n    queryLower.contains(\"' or '1'='1\") ||\n    queryLower.contains(\"; drop table\") ||\n    queryLower.contains(\"; delete from\") ||\n    queryLower.contains(\"admin' --\") ||\n    queryLower.contains(\"'; --\") ||\n    queryLower.contains(\"benchmark(\") ||\n    queryLower.contains(\"sleep(\") ||\n    queryLower.contains(\"waitfor delay\") ||\n    queryLower.contains(\"information_schema\")\n  )) {\n    setAttack(ctx, tags, \"WEB-SQLI-001\", \"SQL Injection\", \"Injection\", \"medium\", \"sqli\");\n  }\n}\n\n// WEB-XSS-001\nif (queryLower != null && (isGet || isPost) && (\"200\".equals(statusStr) || \"500\".equals(statusStr))) {\n  if (queryLower.contains(\"script\") || queryLower.contains(\"javascript\") || queryLower.contains(\"onload\") ||\n      queryLower.contains(\"onerror\") || queryLower.contains(\"onclick\") || queryLower.contains(\"alert\") ||\n      queryLower.contains(\"prompt\") || queryLower.contains(\"confirm\") || queryLower.contains(\"eval\") ||\n      queryLower.contains(\"%3c\") || queryLower.contains(\"&lt;\")) {\n    setAttack(ctx, tags, \"WEB-XSS-001\", \"Cross-Site Scripting\", \"Client-Side\", \"medium\", \"xss\");\n  }\n}\n\n// WEB-PATH-001\nif ((isGet || isPost) && (\"200\".equals(statusStr) || \"403\".equals(statusStr) || \"404\".equals(statusStr) || \"500\".equals(statusStr))) {\n  boolean pathMatch = pathLower != null && (\n    pathLower.contains(\"../\") || pathLower.contains(\"%2e%2e\") || pathLower.contains(\"..%2f\") || pathLower.contains(\"..%5c\")\n  );\n  boolean queryMatch = queryLower != null && (\n    queryLower.contains(\"../\") || queryLower.contains(\"%2e%2e\") ||\n    queryLower.contains(\"/etc/passwd\") || queryLower.contains(\"/etc/hosts\") ||\n    queryLower.contains(\"boot.ini\") || queryLower.contains(\"windows\") ||\n    queryLower.contains(\"file=..\") || queryLower.contains(\"page=..\") || queryLower.contains(\"path=..\")\n  );\n  if (pathMatch || queryMatch) {\n    setAttack(ctx, tags, \"WEB-PATH-001\", \"Path Traversal\", \"File Access\", \"medium\", \"path_traversal\");\n  }\n}\n\n// WEB-CMD-001\nif (queryLower != null && (isGet || isPost) && (\"200\".equals(statusStr) || \"500\".equals(statusStr))) {\n  if (queryLower.contains(\";whoami\") || queryLower.contains(\";id\") || queryLower.contains(\";ls\") ||\n      queryLower.contains(\";cat\") || queryLower.contains(\";pwd\") || queryLower.contains(\"|whoami\") ||\n      queryLower.contains(\"|id\") || queryLower.contains(\"|ls\") || queryLower.contains(\"%3bwhoami\") ||\n      queryLower.contains(\"%3bid\") || queryLower.contains(\"%7cwhoami\") || queryLower.contains(\"%7cid\") ||\n      queryLower.contains(\"&&whoami\") || queryLower.contains(\"&&id\")) {\n    setAttack(ctx, tags, \"WEB-CMD-001\", \"Command Injection\", \"Injection\", \"high\", \"cmdi\");\n  }\n}\n\n// WEB-SCAN-001\nif ((isGet || isHead) && (\"404\".equals(statusStr) || \"403\".equals(statusStr))) {\n  boolean pathScan = pathLower != null && (\n    pathLower.contains(\"/phpmyadmin\") || pathLower.contains(\"/wp-admin\") || pathLower.contains(\"/admin\") ||\n    pathLower.contains(\"/config\") || pathLower.contains(\"/backup\") || pathLower.contains(\"/test\") ||\n    pathLower.contains(\"/debug\") || pathLower.contains(\"/phpinfo\") || pathLower.contains(\"/manager\") ||\n    pathLower.contains(\"/console\") || pathLower.contains(\"/login\") || pathLower.contains(\"/wp-login\") ||\n    pathLower.contains(\"/administrator\") || pathLower.contains(\"/webmin\") || pathLower.contains(\"/cpanel\") ||\n    pathLower.contains(\"/mysql\") || pathLower.contains(\"/database\") || pathLower.contains(\".bak\") ||\n    pathLower.contains(\".sql\") || pathLower.contains(\".zip\")\n  );\n  boolean uaScan = uaLower != null && (\n    uaLower.contains(\"sqlmap\") || uaLower.contains(\"nikto\") || uaLower.contains(\"nmap\") ||\n    uaLower.contains(\"dirb\") || uaLower.contains(\"dirbuster\") || uaLower.contains(\"gobuster\") ||\n    uaLower.contains(\"wfuzz\") || uaLower.contains(\"burp\") || uaLower.contains(\"w3af\") ||\n    uaLower.contains(\"curl\") || uaLower.contains(\"wget\") || uaLower.contains(\"python\") ||\n    uaLower.contains(\"scanner\") || uaLower.contains(\"bot\") || uaLower.contains(\"crawl\")\n  );\n  if (pathScan || uaScan) {\n    setAttack(ctx, tags, \"WEB-SCAN-001\", \"Web Scanning\", \"Reconnaissance\", \"low\", \"scan\");\n  }\n}\n\n// WEB-404-001\nif ((isGet || isHead) && \"404\".equals(statusStr)) {\n  setAttack(ctx, tags, \"WEB-404-001\", \"Repeated 404 Access\", \"Reconnaissance\", \"low\", \"repeated_404\");\n}\n\n// WEB-UA-001\nif ((isGet || isPost || isHead) && uaLower != null) {\n  if (uaLower.contains(\"sqlmap\") || uaLower.contains(\"nikto\") || uaLower.contains(\"nmap\") ||\n      uaLower.contains(\"dirb\") || uaLower.contains(\"dirbuster\") || uaLower.contains(\"gobuster\") ||\n      uaLower.contains(\"wfuzz\") || uaLower.contains(\"burp\") || uaLower.contains(\"w3af\") ||\n      uaLower.contains(\"curl\") || uaLower.contains(\"wget\") || uaLower.contains(\"python-requests\") ||\n      uaLower.contains(\"libwww\") || uaLower.contains(\"go-http-client\") || uaLower.contains(\"java/\") ||\n      uaLower.contains(\"scanner\") || uaLower.contains(\"bot\") || uaLower.contains(\"crawl\") ||\n      uaLower.contains(\"masscan\") || uaLower.contains(\"zmap\") || uaLower.contains(\"nuclei\") ||\n      uaLower.contains(\"acunetix\") || uaLower.contains(\"nessus\") || uaLower.contains(\"openvas\") ||\n      uaLower.contains(\"whatweb\") || uaLower.contains(\"httpx\") || uaLower.contains(\"subfinder\")) {\n    setAttack(ctx, tags, \"WEB-UA-001\", \"Suspicious User-Agent\", \"Reconnaissance\", \"low\", \"suspicious_ua\");\n  }\n}\n\n// WEB-AUTH-001\nif ((isPost || isGet) && pathLower != null && (\"401\".equals(statusStr) || \"403\".equals(statusStr) || \"200\".equals(statusStr))) {\n  if (pathLower.contains(\"/login.php\") || pathLower.contains(\"/login\") || pathLower.contains(\"/auth\") ||\n      pathLower.contains(\"/signin\") || pathLower.contains(\"/sign-in\") || pathLower.contains(\"/logon\") ||\n      pathLower.contains(\"/authentication\") || pathLower.contains(\"/user/login\") ||\n      pathLower.contains(\"/admin/login\") || pathLower.contains(\"/wp-login\") ||\n      pathLower.contains(\"/account/login\") || pathLower.contains(\"/portal/login\") ||\n      pathLower.contains(\"/system/login\")) {\n    setAttack(ctx, tags, \"WEB-AUTH-001\", \"Login Bruteforce\", \"Authentication Abuse\", \"high\", \"auth_bruteforce\");\n  }\n}\n\n// WEB-TIMEOUT-001\nif ((isGet || isPost || isHead) && \"408\".equals(statusStr)) {\n  setAttack(ctx, tags, \"WEB-TIMEOUT-001\", \"Slow Request\", \"Availability\", \"medium\", \"timeout\");\n}\n"
      }
    }
  ]
}
