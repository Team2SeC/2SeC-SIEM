#==============================================================================
# 2SeC SIEM Logstash Pipeline Configuration
# Kinesis Data Stream → Processing → OpenSearch
#==============================================================================

input {
  kinesis {
    # Kinesis Stream 설정 (기존 kinesis.tf 정보 활용)
    kinesis_stream_name => "${KINESIS_STREAM_NAME}"
    region => "${AWS_REGION}"
    
    # Consumer 설정
    application_name => "${PROJECT_NAME}-logstash-consumer"
    initial_position => "TRIM_HORIZON"
    
    # 성능 튜닝
    checkpoint_interval => 10
    metrics => "cloudwatch"
    
    # 코덱 설정 (JSON 로그 처리)
    codec => json {
      charset => "UTF-8"
    }
    
    # 태깅
    add_tag => ["kinesis", "${PROJECT_NAME}", "raw"]
  }
}

filter {
  #---------------------------------------------------------------------------
  # 1. 기본 필드 정리
  #---------------------------------------------------------------------------
  
  # Kinesis 메타데이터 정리
  mutate {
    remove_field => ["@version"]
    add_field => {
	      "pipeline" => "${PROJECT_NAME}-logstash"
      "processed_at" => "%{+yyyy.MM.dd HH:mm:ss}"
    }
  }
  
  # 타임스탬프 정규화
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss", "yyyy/MM/dd HH:mm:ss" ]
      target => "@timestamp"
    }
  }
  
  #---------------------------------------------------------------------------
  # 2. 로그 타입별 파싱
  #---------------------------------------------------------------------------
  
  # DVWA 웹 로그 파싱
  if [log_type] == "web" or "web" in [tags] {
    grok {
      match => { 
        "message" => "%{COMBINEDAPACHELOG}"
      }
      add_tag => ["web_parsed"]
    }
    
    # User-Agent 분석
    if [agent] {
      useragent {
        source => "agent"
        target => "user_agent"
      }
    }
    
    # IP 지역 정보 (선택적)
    if [clientip] {
      mutate {
        add_field => { "source_ip" => "%{clientip}" }
    }
  }
  
  # 시스템 로그 파싱 (syslog)
  else if [log_type] == "system" or "system" in [tags] {
    grok {
      match => { 
        "message" => "%{SYSLOGLINE}"
      }
      add_tag => ["system_parsed"]
    }
  }
  
  # 보안 이벤트 로그
  else if [log_type] == "security" or "security" in [tags] {
    # JSON 구조 그대로 사용
    mutate {
      add_tag => ["security_event"]
    }
    
    # 위험도 레벨 설정
    if [event_type] == "sql_injection" or [event_type] == "xss" {
      mutate {
        add_field => { "risk_level" => "high" }
      }
    } else if [event_type] == "brute_force" {
      mutate {
        add_field => { "risk_level" => "medium" }
      }
    } else {
      mutate {
        add_field => { "risk_level" => "low" }
      }
    }
  }
  
  #---------------------------------------------------------------------------
  # 3. 공통 필드 추가
  #---------------------------------------------------------------------------
  
  mutate {
    # 인덱스 구분용
    add_field => {
      "index_date" => "%{+yyyy.MM.dd}"
      "data_source" => "${PROJECT_NAME}-siem"
    }
  }
  
  #---------------------------------------------------------------------------
  # 4. 데이터 정제
  #---------------------------------------------------------------------------
  
  # 빈 필드 제거
  mutate {
    remove_field => ["host", "path", "[@metadata]"]
  }
  
  # 에러 로그 태깅
  if "_grokparsefailure" in [tags] {
    mutate {
      add_tag => ["parse_error"]
      add_field => { "parse_status" => "failed" }
    }
  } else {
    mutate {
      add_field => { "parse_status" => "success" }
    }
  }
}

  #---------------------------------------------------------------------------
  # 개발용 출력 (테스트 시에만)
  #---------------------------------------------------------------------------
  
  # stdout {
  #   codec => rubydebug {
  #     metadata => false
  #   }
  # }
}