#==============================================================================
# 2SeC SIEM Logstash Pipeline Configuration  
# Kinesis Data Stream â†’ Processing â†’ OpenSearch
#==============================================================================

input {
  kinesis {
    kinesis_stream_name => "${KINESIS_STREAM_NAME}"
    region => "${AWS_REGION}"
    application_name => "${PROJECT_NAME}-logstash-consumer"
    
    codec => json
    tags => ["kinesis", "raw"]  
  }
}

filter {
  #---------------------------------------------------------------------------
  # 1. ê¸°ë³¸ í•„ë“œ ì •ë¦¬
  #---------------------------------------------------------------------------
  mutate {
    remove_field => ["@version", "host", "path", "port", "type"]
    add_field => {
      "pipeline" => "${PROJECT_NAME}-logstash"
    }
  }
  
  # íƒ€ìž„ìŠ¤íƒ¬í”„ ì •ê·œí™”
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601"]
      target => "@timestamp"
    }
  }
  
  #---------------------------------------------------------------------------
  # 2. ë¡œê·¸ íƒ€ìž…ë³„ íŒŒì‹±
  #---------------------------------------------------------------------------
  if [log_type] == "web" {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
      add_tag => ["web_parsed"]
    }
    
    if [agent] {
      useragent {
        source => "agent"
        target => "user_agent"
      }
    }
  }
  
  if [log_type] == "system" {
    grok {
      match => { "message" => "%{SYSLOGLINE}" }
      add_tag => ["system_parsed"]
    }
  }
  
  if [log_type] == "security" {
    mutate { add_tag => ["security_event"] }

# if-else êµ¬ì¡°ë¡œ ë˜ì–´ìžˆì–´ì„œ í™•ìž¥ì„±ì— ìžˆì–´ ìˆœì°¨ ì²˜ë¦¬ë¡œ ë¹„íš¨ìœ¨ì ì´ë¼ì„œ ìˆ˜ì •í–ˆì–´ìš”
    
    # ìœ„í—˜ë„ ë ˆë²¨ ì„¤ì •
    if [event_type] in ["sql_injection", "xss"] {
      mutate { add_field => { "risk_level" => "high" } }
    } else if [event_type] == "brute_force" {
      mutate { add_field => { "risk_level" => "medium" } }
    } else {
      mutate { add_field => { "risk_level" => "low" } }
    }
  }
  
  #---------------------------------------------------------------------------
  # 3. ìµœì¢… ì •ì œ
  #---------------------------------------------------------------------------
  
  # íŒŒì‹± ìƒíƒœ íƒœê¹…
  if "_grokparsefailure" in [tags] {
    mutate {
      add_tag => ["parse_error"]
      add_field => { "parse_status" => "failed" }
    }
  } else {
    mutate {
      add_field => { "parse_status" => "success" }
    }
  }
}

#==============================================================================
# OUTPUT
#==============================================================================
output {
  # OpenSearchë¡œ ë©”ì¸ ë°ì´í„° ì „ì†¡
  elasticsearch {
    hosts => ["https://${OPENSEARCH_HOST}"]
    index => "${PROJECT_NAME}-siem-%{+yyyy.MM.dd}"     # âœ… í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
    
    # IAMìœ¼ë¡œ ë³€ê²½
    auth_type => {
      type => 'aws_iam'
      region => "${AWS_REGION}"
    }
    
    ecs_compatibility => disabled
    
    retry_on_conflict => 3
  }
  
  # ðŸ”¥ ìˆ˜ì •: CloudWatch ë©”íŠ¸ë¦­ ì„¤ì •ìœ¼ë¡œ ë³€ê²½
  if "parse_error" in [tags] {
    cloudwatch {
      metricname => "ParseErrors"                    # log_group_name ëŒ€ì‹ 
      namespace => "SIEM/Logstash"                   # ë„¤ìž„ìŠ¤íŽ˜ì´ìŠ¤
      region => "${AWS_REGION}"
      unit => "Count"                                # ë‹¨ìœ„
      value => "1"                                   # ê°’
      
      # ì„ íƒì‚¬í•­: ì°¨ì› ì¶”ê°€
      dimensions => { 
        "Environment" => "Test"
        "Project" => "${PROJECT_NAME}"
      }
    }
  }
}