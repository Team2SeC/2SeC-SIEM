# Logstash Pipeline
# Kinesis (gzip) → JSON → stdout / OpenSearch

input {
  kinesis {
    kinesis_stream_name => "${KINESIS_STREAM_NAME}"
    region              => "${AWS_REGION}"
    application_name    => "${APPLICATION_NAME}"

    codec => gzip {
      charset => "UTF-8"
    }
  }
}

filter {
  mutate {
    add_field => {
      "ingest_source" => "kinesis"
    }
  }

  # JSON 파싱
  json {
    source => "message"
    target => "parsed"
    tag_on_failure => ["_jsonparsefailure"]
  }
}

output {
  # OpenSearch
  opensearch {
    hosts => ["https://${OPENSEARCH_HOST}:443"]
    index => "2sec-siem-%{+yyyy.MM.dd}"

    auth_type => {
      type   => "aws_iam"
      region => "${AWS_REGION}"
    }

    ecs_compatibility => disabled
    manage_template   => false
  }

  # =========================
  # 디버깅용 (같이 써도 됨)
  # =========================
  #stdout {
  #  codec => rubydebug
  #}
}